<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="开始的路就不叫远方" />



  <meta name="keywords" content="NSCoding,Object C,iOS入门,应用状态," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>




  <title> iOS 保存和读取本地数据 // Frank </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Frank</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              iOS 保存和读取本地数据
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-06-07
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/06/07/2015-06-07-ios-saving-loading-local-data/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/07/2015-06-07-ios-saving-loading-local-data/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <h3 id="类要遵循的[protocol]和实现的methods_(id:top)">类要遵循的[protocol]和实现的methods  (id:top)</h3><blockquote>
<blockquote>
<p>要想将一个object中的property保存到本地, 这个object的对应的class应该遵循 NSCoding协议, 并实现其2个methods: </p>
</blockquote>
</blockquote>
<ul>
<li>NSCoding protocol</li>
</ul>
<figure class="highlight"><figcaption><span>c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@interface BNRItem : NSObject &#60;NSCoding&#62;</span><br></pre></td></tr></table></figure>
<ul>
<li>encodeWIthCoder </li>
</ul>
<p>将class中的property以key-value的形式进行encode, 并将数据流存储到本地的文件系统中, 其中key设定为property的名称.</p>
<figure class="highlight"><figcaption><span>c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)encodeWithCoder:(NSCoder *)aCoder&#123;&#10;    &#10;    [aCoder encodeObject:self.itemName forKey:@&#34;itemName&#34;];&#10;    [aCoder encodeObject:self.serialNumber forKey:@&#34;serialNumber&#34;];&#10;    [aCoder encodeObject:self.dateCreated forKey:@&#34;dateCreated&#34;];&#10;    [aCoder encodeObject:self.itemKey forKey:@&#34;itemKey&#34;];&#10;    [aCoder encodeInt:self.valueInDollars forKey:@&#34;valueInDollars&#34;];&#10;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>initWithCoder </li>
</ul>
<p>从encodeWithCoder中的数据中, 恢复数据, 并赋值给各个property,</p>
<figure class="highlight"><figcaption><span>c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (id)initWithCoder:(NSCoder *)aDecoder&#123;&#10;    self = [super init];&#10;    if (self) &#123;&#10;        _itemName = [aDecoder decodeObjectForKey:@&#34;itemName&#34;];&#10;        _serialNumber = [aDecoder decodeObjectForKey:@&#34;serialNumber&#34;];&#10;        _dateCreated = [aDecoder decodeObjectForKey:@&#34;dateCreated&#34;];&#10;        _itemKey = [aDecoder decodeObjectForKey:@&#34;itemKey&#34;];&#10;        _valueInDollars = [aDecoder decodeIntForKey:@&#34;valueInDollars&#34;];&#10;    &#125;&#10;    &#10;    return self;&#10;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="选定保存数据的路径和目录">选定保存数据的路径和目录</h3><p>每一个应用都有其对应的sandbox, 只有本身可以访问,与其他app隔离, sandbox包含的目录有:</p>
<ul>
<li><p>application bundle: 只读, NIB和图标等文件</p>
</li>
<li><p>Documents/: 存储的文件, 可用iCloud备份;</p>
</li>
<li><p>Library/Caches/: 缓存的文件, 不能备份;</p>
</li>
<li><p>Library/Preferences/: app的setting等设置</p>
</li>
<li><p>tmp/ : 临时文件, 注意其清理</p>
</li>
</ul>
<p>查找Document/的目录代码并指定保存的文件名称:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *) itemArchivePath &#123;</span><br><span class="line">   NSArray *documentDirs =  NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);</span><br><span class="line">    </span><br><span class="line">    NSString * documentDir = [documentDirs firstObject];</span><br><span class="line">    NSString *fileName = @<span class="string">"item.archive"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>  [documentDir stringByAppendingPathComponent:fileName];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="如何开始将数据保存到本地">如何开始将数据保存到本地</h3><p>设定好要保存的property和路径后, 就需要在app进入后台的时候(双击home键), 触发保存事件.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)applicationDidEnterBackground:(UIApplication *)application</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later. </span></span><br><span class="line">    <span class="comment">// If your application supports background execution, this method is called instead of applicationWillTerminate: when the user quits.</span></span><br><span class="line">    BOOL success = [[BNRItemStore sharedStore] saveChanges];</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        NSLog(@<span class="string">"saved all items"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        NSLog(@<span class="string">"Failed: can't sace items data!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* save changes保存的函数</span><br><span class="line">*  self.privateItems为一个数组, 里面包含了多个item</span><br><span class="line">*/</span> NSKeyedArchiver 会递归的调用数组里每一个item的 encodeWithCoder 方法</span><br><span class="line">- (BOOL) saveChanges&#123;</span><br><span class="line">    NSString * fileName = [self itemArchivePath]; </span><br><span class="line">    <span class="keyword">return</span> [NSKeyedArchiver archiveRootObject:self.privateItems toFile:fileName];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="如何将数据load到app中">如何将数据load到app中</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSString *path = [self itemArchivePath];</span><br><span class="line">_privateItems = [NSKeyedUnarchiver unarchiveObjectWithFile:path];</span><br></pre></td></tr></table></figure>
<h3 id="对于图片的保存,_可以采用NSData的writeToFile:path">对于图片的保存, 可以采用NSData的writeToFile:path</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取图片的保存目录</span></span><br><span class="line">- (NSString *)imagePathForKey:(NSString *)key</span><br><span class="line">&#123;</span><br><span class="line">    NSArray *documentDirectories =</span><br><span class="line">            NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,</span><br><span class="line">                                                NSUserDomainMask,</span><br><span class="line">                                                YES);</span><br><span class="line">    NSString *documentDirectory = [documentDirectories firstObject];</span><br><span class="line">    <span class="keyword">return</span> [documentDirectory stringByAppendingPathComponent:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存图片到本地</span></span><br><span class="line">NSString *imagePath = [self imagePathForKey:key];</span><br><span class="line"> <span class="comment">// Turn image into JPEG data</span></span><br><span class="line">    NSData *data = UIImageJPEGRepresentation(image, <span class="number">0.5</span>);</span><br><span class="line">    <span class="comment">// Write it to full path</span></span><br><span class="line">    [data writeToFile:imagePath atomically:YES];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取本地的图片</span></span><br><span class="line">NSString *imagePath = [self imagePathForKey:key];</span><br><span class="line"> <span class="comment">// Create UIImage object from file</span></span><br><span class="line">  result = [UIImage imageWithContentsOfFile:imagePath];</span><br></pre></td></tr></table></figure>
<p>返回<a href="#top">顶部</a></p>
<p>At 15:56 PM</p>
<h2 id="参考资料">参考资料</h2><ul>
<li>iOS Programming The Big Nerd Ranch Guide 4th Edition</li>
</ul>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/NSCoding/"> #NSCoding </a>
          
            <a href="/tags/Object-C/"> #Object C </a>
          
            <a href="/tags/iOS入门/"> #iOS入门 </a>
          
            <a href="/tags/应用状态/"> #应用状态 </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/06/02/2015-06-02-ios-url-json/">iOS URL请求和JSON的解析</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2015/06/07/2015-06-07-ios-saving-loading-local-data/"
               data-title="iOS 保存和读取本地数据" data-url="http://jiangyewen.github.com/2015/06/07/2015-06-07-ios-saving-loading-local-data/">
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="http://ww2.sinaimg.cn/mw690/8040b9dbjw8ehrax5unptj20dc0dc0uj.jpg" alt="蒋业文" />
          <p class="site-author-name">蒋业文</p>
        </div>
        <p class="site-description motion-element">开始的路就不叫远方</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/jiangyewen" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/dawnbird" target="_blank">Weibo</a>
            </span>
            
          
        </div>

        
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#类要遵循的[protocol]和实现的methods_(id:top)"><span class="nav-number">1.</span> <span class="nav-text">类要遵循的[protocol]和实现的methods  (id:top)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选定保存数据的路径和目录"><span class="nav-number">2.</span> <span class="nav-text">选定保存数据的路径和目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何开始将数据保存到本地"><span class="nav-number">3.</span> <span class="nav-text">如何开始将数据保存到本地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何将数据load到app中"><span class="nav-number">4.</span> <span class="nav-text">如何将数据load到app中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对于图片的保存,_可以采用NSData的writeToFile:path"><span class="nav-number">5.</span> <span class="nav-text">对于图片的保存, 可以采用NSData的writeToFile:path</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number"></span> <span class="nav-text">参考资料</span></a></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2014 - 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">蒋业文</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js"></script>


  <script type="text/javascript" src="/js/helpers.js"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js" id="motion.global"></script>




  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"jiangyewen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  

</body>
</html>
